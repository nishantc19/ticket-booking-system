# Ticket Booking System

## About The Project

This project is a POC for Event driven microservice architecture using Spring boot. The microservices demonstrates choreography based SAGA pattern. For this POC, Kafka is the center piece and is being used as a message bus.

This is a snippet of movie ticket booking system which focuses on booking a seat. There are 4 services involved:
* [show-service](https://github.com/nishantc19/ticket-booking-system/tree/master/show-service) is the main service in the project, which is responsible for creating a show, adding seats to the show and updating seat status. This service is also implementing database level concurrency control for avoiding duplicate seat bookings by multiple customers.
* [kafka](https://github.com/nishantc19/ticket-booking-system/tree/master/kafka) service is more of a configuration service responsibile for creating kafka topics.
* [booking-service](https://github.com/nishantc19/ticket-booking-system/tree/master/booking-service) and [payment-service](https://github.com/nishantc19/ticket-booking-system/tree/master/payment-service) are kind of mock services, just for the sake of completing the operation flow and demonstrating how microservices can communicate asynchronously.

## Prerequisites

This project demands basic understanding of how Java Spring boot API service works and how to build a Java web-applications using Maven. Since Kafka is the certer piece, theoritical knowledge is a must. Also, you should know how to clone a git repository on your local.

I have used [cURL](https://developer.ibm.com/articles/what-is-curl-command/) for talking with the services. You can also use Postman or other similar tools.

## Getting started

1. The project is using Java 11, so you need to configure the build path accordingly.
2. Clone the repository on your local.
3. Build the services.
4. Open the command prompt and go to the directory where Kafka is installed.
5. Start the Zookeeper using following command:
```bash
bin\windows\zookeeper-server-start.bat config\zookeeper.properties
```
6. Start the Kafka server using following command:
```bash
bin\windows\kafka-server-start.bat config\server.properties
```
7. Run the [kafka](https://github.com/nishantc19/ticket-booking-system/tree/master/kafka) service on the server. It will create all the required topics in Kafka.
8. Run rest of the services: [show-service](https://github.com/nishantc19/ticket-booking-system/tree/master/show-service), [payment-service](https://github.com/nishantc19/ticket-booking-system/tree/master/payment-service) and [booking-service](https://github.com/nishantc19/ticket-booking-system/tree/master/booking-service).

Note:
If you are using windows like me, and want to use cURL, you might want to [read this](https://developer.zendesk.com/documentation/developer-tools/getting-started/installing-and-using-curl/#installing-curl).

## The process of booking a seat successfully

1. #### Create a show
In order to book a seat, a show should be created first. This API will be accessible only to the administrators. Whenever a Theater purchases a movie, shows for that movie will be created. Following request should be executed for creating show and adding seats:
```bash
curl --header "Content-Type: application/json" --request POST --data "{\"startTimestamp\": \"2021-08-04T10:10:00\",\"endTimestamp\": \"2021-08-04T12:10:00\",\"movieName\": \"Pirates of the caribbean: Dead man tell no tales\",\"seats\": [{\"seatId\": \"1\", \"name\": \"A1\", \"price\": \"350.00\", \"status\":\"available\"},{\"seatId\": \"2\", \"name\": \"A2\", \"price\": \"350.00\", \"status\":\"available\"}]}" http://localhost:9002/show/
```

2. #### Update the seat status
When a customer selects a seat and proceeds to the payment, a change in seat status is triggered internally. To immitate the flow, make the following request:
```bash
curl --header "Content-Type: application/json" --request PATCH "http://localhost:9002/showseat/1/status?version=0&status=reserved"
```
The response for this request will be a unique id generated to identify this booking through out the system. Here onward, all transactions will be carried out using this unique id.

3. #### Make the payment
When a customer makes a payment, the seat status will be updated again. In this case, a successful payment is taken into consideration. This update will be triggered internally by the payment service. A successful payment will confirm the seat and then the ticket will be generated by booking service. Note that, the payment service will also use the unique id to carry forward the transaction. Therefore unique id generated from the last update should be used as a value to `uniqueId` field.
```bash
curl --header "Content-Type: application/json" --request POST --data "{\"uniqueId\": \"369519de-6e6f-4ef5-9f0c-d53fa714950f\",\"userId\": 101}" http://localhost:9003/payment/
```

4. #### Check the ticket
When the whole process gets completed, the ticket will be generated. This ticket will be saved in Kafka. To view the kafka messages in the booking topic, use the following command:
```bash
bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic booking --from-beginning
```

If you are able to see the ticket, the process is completed successfully.

If you want to see the intermediate messages being produced by the services, lets say show-service, you can replace the topic name in the above command with `show-seat`. You can find the all the topics in [application.yml](https://github.com/nishantc19/ticket-booking-system/blob/master/kafka/src/main/resources/application.yml)